{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Work/Downloads/th.gg/townhall/src/proxy.ts"],"sourcesContent":["/**\n * @Author: BensonByte\n * @Date:   12/19/25 23:11:47 C8T\n * @Last Modified by:   BensonByte\n * @Last Modified time: 12/20/25 01:11:12 C2T\n */\n/**\n * Next.js Middleware for Custom Domain Handling\n *\n * Detects custom domains and rewrites requests to the custom domain handler.\n * Custom domains can only access form-related endpoints, not the full app.\n */\n\nimport { NextResponse } from \"next/server\";\nimport type { NextRequest } from \"next/server\";\n\n// Main domains that should be handled normally (full app access)\nconst MAIN_DOMAINS = [\n  \"townhall.gg\",\n  \"localhost:3000\",\n  \"127.0.0.1:3000\",\n  \"localhost\",\n  \"127.0.0.1\",\n  \"*.townhall.gg\",\n  \"www.townhall.gg\",\n];\n\n// Paths ALLOWED on custom domains (whitelist approach for security)\nconst CUSTOM_DOMAIN_ALLOWED_PATHS = [\n  \"/f/\", // Form submission endpoint (POST submissions)\n  \"/f\", // exactly /f\n  \"/f/*\", // /f/ and anything under /f/ (wildcard)\n  \"/embed/\", // Embeddable form pages\n  \"/embed\", // Embed route\n  \"/api/track/\", // Email tracking pixels\n  \"/api/unsubscribe/\", // Email unsubscribe endpoint\n  \"/unsubscribe/\", // Unsubscribe page\n  \"/_next/\", // Next.js static assets\n  \"/static/\", // Static files\n  \"/favicon.ico\",\n  \"/robots.txt\",\n  \"/hero-bg.png\",\n  \"/embed.js\", // Embed script\n  \"/.well-known/\", // For SSL verification etc.\n];\n\n// Paths explicitly blocked on custom domains (for clarity)\nconst CUSTOM_DOMAIN_BLOCKED_PATHS = [\n  \"/dashboard\",\n  \"/login\",\n  \"/register\",\n  \"/forgot-password\",\n  \"/reset-password\",\n  \"/verify-email\",\n  \"/verify-required\",\n  \"/2fa\",\n  \"/api/auth/\",\n  \"/api/admin/\",\n  \"/api/user/\",\n  \"/api/workspaces/\",\n  \"/api/forms/\",\n  \"/api/files/\",\n  \"/api/crm/\",\n  \"/api/polar/\",\n  \"/api/webhooks/\",\n  \"/api/internal/\",\n  \"/api/invites/\",\n  \"/api/links/\",\n  \"/api/api-keys/\",\n  \"/api/export/\",\n  \"/api/onboarding\",\n  \"/docs\",\n  \"/support\",\n  \"/about\",\n  \"/careers\",\n  \"/blog\",\n  \"/legal\",\n  \"/non-profits\",\n  \"/nonprofit\",\n  \"/invite/\",\n  \"/go\",\n  \"/l/\",\n  \"\",\n];\n\nexport function proxy(request: NextRequest) {\n  const hostname = request.headers.get(\"host\") || \"\";\n  const pathname = request.nextUrl.pathname;\n\n  // Skip proxy for internal rewrites (already processed)\n  if (pathname.startsWith(\"/custom-domain/\")) {\n    return NextResponse.next();\n  }\n\n  // Remove port for comparison\n  const hostnameWithoutPort = hostname.split(\":\")[0];\n\n  // Check if this is a main domain\n  const isMainDomain = MAIN_DOMAINS.some((domain) => {\n    const domainWithoutPort = domain.split(\":\")[0];\n    return (\n      hostnameWithoutPort === domainWithoutPort ||\n      hostnameWithoutPort.endsWith(\".\" + domainWithoutPort)\n    );\n  });\n\n  // Allow Vercel preview deployments\n  if (hostnameWithoutPort.endsWith(\".vercel.app\")) {\n    return NextResponse.next();\n  }\n\n  // Allow localhost in development UNLESS explicitly testing custom domains\n  // Set CUSTOM_DOMAIN_TEST=true in .env.local to test blocking locally\n  const isLocalhost = hostnameWithoutPort === \"localhost\" || hostnameWithoutPort === \"127.0.0.1\";\n  const isTestingCustomDomains = process.env.CUSTOM_DOMAIN_TEST === \"true\";\n\n  if (process.env.NODE_ENV === \"development\" && isLocalhost && !isTestingCustomDomains) {\n    return NextResponse.next();\n  }\n\n  // If it's a main domain, proceed normally with full access\n  if (isMainDomain) {\n    return NextResponse.next();\n  }\n\n  // === CUSTOM DOMAIN HANDLING ===\n  // Custom domains have restricted access - only form-related endpoints\n\n  // Check if path is explicitly blocked\n  const isBlocked = CUSTOM_DOMAIN_BLOCKED_PATHS.some(\n    (path) => pathname === path || pathname.startsWith(path),\n  );\n\n  if (isBlocked) {\n    // Rewrite to the restricted page (shows a nice UI explaining the domain)\n    const url = request.nextUrl.clone();\n    url.pathname = \"/custom-domain/restricted\";\n\n    const response = NextResponse.rewrite(url);\n    response.headers.set(\"x-custom-domain\", hostname);\n    return response;\n  }\n\n  // Check if path is allowed (whitelist)\n  const isAllowed = CUSTOM_DOMAIN_ALLOWED_PATHS.some((path) => pathname.startsWith(path));\n\n  // For allowed paths like /f/[formId], pass through normally\n  if (isAllowed) {\n    const response = NextResponse.next();\n    response.headers.set(\"x-custom-domain\", hostname);\n    return response;\n  }\n\n  // Root path and unknown paths - rewrite to custom domain handler\n  // This handles the form landing page at /\n  if (pathname === \"/\" || pathname === \"\") {\n    const url = request.nextUrl.clone();\n    url.pathname = `/custom-domain/${hostname}${pathname}`;\n\n    const response = NextResponse.rewrite(url);\n    response.headers.set(\"x-custom-domain\", hostname);\n    return response;\n  }\n\n  // Any other unrecognized path - show restricted page\n  const url = request.nextUrl.clone();\n  url.pathname = \"/custom-domain/restricted\";\n\n  const response = NextResponse.rewrite(url);\n  response.headers.set(\"x-custom-domain\", hostname);\n  return response;\n}\n\nexport const config = {\n  // Match all paths except static files and API routes that need special handling\n  matcher: [\n    /*\n     * Match all request paths except for the ones starting with:\n     * - _next/static (static files)\n     * - _next/image (image optimization files)\n     * - favicon.ico (favicon file)\n     */\n    \"/((?!_next/static|_next/image|favicon.ico).*)\",\n  ],\n};\n"],"names":[],"mappings":"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"}}]
}